<!-- myapp/templates/dataset/run.html -->
{% extends 'base.html' %}

{% block title %}AI评测系统 - 运行评测集{% endblock %}

{% block content %}
<!-- 运行评测集页面 -->
<div id="run-dataset-content">
    <div class="header">
        <h1><i class="bi bi-play-circle me-3"></i>运行评测集</h1>
        <p class="mb-0">选择评测集并运行测试</p>
    </div>
    
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-key me-2"></i>API配置</h5>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label for="api_key" class="form-label">API密钥</label>
                <input type="password" class="form-control" id="api_key" name="api_key" placeholder="请输入API密钥" required>  
                <div class="form-text">请输入用于访问AI服务的API密钥</div>
            </div>
        </div>
    </div>
    
    <!-- 评测集选择卡片 -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0"><i class="bi bi-collection me-2"></i>选择评测集</h5>
        </div>
        <div class="card-body">
            {% if evaluation_sets %}
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 5%;">
                                <input type="checkbox" id="select-all-checkbox">
                            </th>
                            <th style="width: 40%;">评测集名称</th>
                            <th style="width: 20%;">语料数量</th>
                            <th style="width: 35%;">意图</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for eval_set in evaluation_sets %}
                        <tr>
                            <td>
                                <input type="checkbox" class="dataset-checkbox" name="evaluation_sets" value="{{ eval_set.id }}">
                            </td>
                            <td>{{ eval_set.name }}</td>
                            <td>{{ eval_set.get_corpora_count }}</td>
                            <td>
                                {% for intent in eval_set.top_intents %}
                                    <span class="badge bg-secondary me-1">{{ intent }}</span>
                                {% endfor %}
                                {% if eval_set.intent_count > 5 %}
                                    <span class="badge bg-light text-dark">+{{ eval_set.intent_count|add:"-5" }} 更多</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-1"></i>
                暂无可用评测集，请先创建评测集
            </div>
            {% endif %}
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selected-count" class="text-muted">已选择 0 个评测集</span>
                </div>
                <button type="button" class="btn btn-primary btn-lg" id="run-button" {% if not evaluation_sets %}disabled{% endif %}>
                    <i class="bi bi-play me-1"></i>开始测试
                </button>
            </div>
        </div>
    </div>
    
    <!-- 进度显示 -->
    <div class="alert alert-info d-none progress-container mt-4" id="progress-container">
        <div class="d-flex align-items-center">
            <div class="spinner-border text-primary me-3" role="status">
                <span class="visually-hidden">处理中...</span>
            </div>
            <div>
                <strong>正在处理...</strong>
                <div id="progress-text" class="progress-text">开始处理...</div>
            </div>
        </div>
        <div class="progress mt-3">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
                 role="progressbar" style="width: 0%"></div>
        </div>
        <div class="mt-2">
            <button id="cancel-run" class="btn btn-sm btn-outline-danger">
                <i class="bi bi-x-circle me-1"></i>取消运行
            </button>
        </div>
    </div>
    
    <!-- 测试结果展示 -->
    <div id="results-container" class="mt-4"></div>
    
    <!-- 隐藏的CSRF token -->
    {% csrf_token %}
</div>
{% endblock %}

{% block scripts %}
<script>
    // 页面加载时检查是否有正在进行的任务
    document.addEventListener('DOMContentLoaded', function() {
        // 从localStorage获取保存的运行信息
        const savedRunInfo = localStorage.getItem('evaluationRunInfo');
        if (savedRunInfo) {
            const runInfo = JSON.parse(savedRunInfo);
            // 显示进度条并恢复信息
            document.getElementById('progress-container').classList.remove('d-none');
            document.getElementById('progress-text').innerText = '恢复监控中...';
            
            // 恢复表单数据
            if (runInfo.apiKey) {
                document.getElementById('api_key').value = runInfo.apiKey;
            }
            
            // 检查运行是否仍在进行中
            checkAllStatus(runInfo.runIds, runInfo.completedRuns || []);
        }
        
        // 全选/取消全选功能
        const selectAllCheckbox = document.getElementById('select-all-checkbox');
        const datasetCheckboxes = document.querySelectorAll('.dataset-checkbox');
        const selectedCount = document.getElementById('selected-count');
        
        selectAllCheckbox.addEventListener('change', function() {
            datasetCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            updateSelectedCount();
        });
        
        // 更新选中数量
        datasetCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateSelectedCount);
        });
        
        // 运行按钮事件
        document.getElementById('run-button').addEventListener('click', runEvaluation);
        
        // 初始化选中数量
        updateSelectedCount();
    });
    
    // 更新选中数量显示
    function updateSelectedCount() {
        const selectedCount = document.getElementById('selected-count');
        const checkedCount = document.querySelectorAll('.dataset-checkbox:checked').length;
        selectedCount.textContent = `已选择 ${checkedCount} 个评测集`;
    }
    
    // 运行评测
    function runEvaluation() {
        const apiKey = document.getElementById('api_key').value;
        const selectedCheckboxes = document.querySelectorAll('.dataset-checkbox:checked');
        
        if (!apiKey) {
            alert('请输入API密钥');
            return;
        }
        
        if (selectedCheckboxes.length === 0) {
            alert('请至少选择一个评测集');
            return;
        }
        
        // 获取选中的评测集ID
        const evaluationSetIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        
        // 准备表单数据
        const formData = new FormData();
        formData.append('api_key', apiKey);
        evaluationSetIds.forEach(id => {
            formData.append('evaluation_sets', id);
        });
        
        // 显示进度条
        document.getElementById('progress-container').classList.remove('d-none');
        document.getElementById('progress-text').innerText = '开始处理...';
        document.getElementById('progress-bar').style.width = '0%';
        
        // 获取CSRF token
        const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
        if (!csrfTokenElement) {
            console.error('CSRF token not found');
            // 隐藏进度条
            document.getElementById('progress-container').classList.add('d-none');
            alert('提交失败：CSRF token缺失');
            return;
        }
        
        const csrfToken = csrfTokenElement.value;
        
        // 发送请求
        fetch('{% url "run_evaluation" %}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            if (data.status === 'success') {
                // 保存运行ID到localStorage
                const runInfo = {
                    runIds: data.run_ids || [data.run_id], // 兼容旧版本
                    apiKey: apiKey,
                    startTime: new Date().toISOString(),
                    completedRuns: []
                };
                localStorage.setItem('evaluationRunInfo', JSON.stringify(runInfo));
                
                // 开始检查状态
                checkAllStatus(runInfo.runIds, []);
            } else {
                // 隐藏进度条
                document.getElementById('progress-container').classList.add('d-none');
                alert('提交失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            // 隐藏进度条
            document.getElementById('progress-container').classList.add('d-none');
            alert('提交失败，请重试: ' + error.message);
        });
    }
    
    // 检查所有任务状态
    function checkAllStatus(runIds, completedRuns) {
        const resultsContainer = document.getElementById('results-container');
        
        let processingCount = 0;
        let totalProcessed = 0;
        let totalTotal = 0;
        let finishedCount = 0;
        
        // 检查每个运行的状态
        const checkPromises = runIds.map(runId => {
            return new Promise(resolve => {
                fetch(`/evaluation/status/?run_id=${runId}`)
                    .then(response => response.json())
                    .then(data => {
                        console.log(`Status check result for run ${runId}:`, data);
                        if (data.status === 'processing') {
                            processingCount++;
                            totalProcessed += data.processed;
                            totalTotal += data.total;
                            
                            // 显示处理中卡片
                            showProcessingCard(runId, data);
                        } else if (data.status === 'completed') {
                            finishedCount++;
                            
                            // 显示结果卡片
                            showResults(runId, data);
                            
                            // 更新localStorage
                            updateLocalStorage(runId);
                        } else if (data.status === 'failed') {
                            finishedCount++;
                            
                            // 显示错误卡片
                            showError(runId, data);
                            
                            // 更新localStorage
                            updateLocalStorage(runId);
                        } else if (data.status === 'not_found') {
                            // 任务不存在，视为完成
                            finishedCount++;
                        }
                        resolve();
                    })
                    .catch(error => {
                        console.error('Status check error:', error);
                        resolve();
                    });
            });
        });
        
        Promise.all(checkPromises).then(() => {
            // 更新总体进度
            if (finishedCount < runIds.length) {
                const progressPercent = totalTotal > 0 ? Math.round((totalProcessed / totalTotal) * 100) : 0;
                document.getElementById('progress-text').innerText = 
                    `处理中...(${processingCount} 个任务运行中, ${finishedCount}/${runIds.length} 个任务完成)`;
                document.getElementById('progress-bar').style.width = `${progressPercent}%`;
                
                // 继续检查状态
                setTimeout(() => checkAllStatus(runIds, completedRuns), 1000);
            } else {
                // 所有任务完成，隐藏进度条
                document.getElementById('progress-container').classList.add('d-none');
                // 清除localStorage
                localStorage.removeItem('evaluationRunInfo');
            }
        });
    }
    
    // 更新localStorage
    function updateLocalStorage(runId) {
        const savedRunInfo = JSON.parse(localStorage.getItem('evaluationRunInfo') || '{}');
        if (savedRunInfo.completedRuns && !savedRunInfo.completedRuns.includes(runId)) {
            savedRunInfo.completedRuns.push(runId);
            localStorage.setItem('evaluationRunInfo', JSON.stringify(savedRunInfo));
        }
    }
    
    // 显示处理中卡片
    function showProcessingCard(runId, data) {
        const resultsContainer = document.getElementById('results-container');
        
        // 检查卡片是否已存在
        let card = document.getElementById(`processing-card-${runId}`);
        if (!card) {
            // 创建处理中卡片
            card = document.createElement('div');
            card.id = `processing-card-${runId}`;
            card.className = 'card mt-3';
            card.innerHTML = `
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">正在处理: ${data.evaluation_set_name || '评测集'} (ID: ${runId})</h5>
                    <button class="btn btn-sm btn-light" type="button" data-bs-toggle="collapse" data-bs-target="#processing-body-${runId}" aria-expanded="true" aria-controls="processing-body-${runId}">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                </div>
                <div class="collapse show" id="processing-body-${runId}">
                    <div class="card-body">
                        <div class="d-flex align-items-center mb-3">
                            <div class="spinner-border text-primary me-3" role="status">
                                <span class="visually-hidden">处理中...</span>
                            </div>
                            <div>
                                <strong>正在处理中...</strong>
                                <div class="processing-text">准备开始处理...</div>
                            </div>
                        </div>
                        <div class="progress">
                            <div class="progress-bar progress-bar-striped progress-bar-animated processing-bar" 
                                 role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">语料总数: ${data.total || 0}</small>
                        </div>
                    </div>
                </div>
            `;
            resultsContainer.appendChild(card);
        }
        
        // 更新处理进度
        const processingText = card.querySelector('.processing-text');
        const processingBar = card.querySelector('.processing-bar');
        
        if (processingText && processingBar) {
            const progressPercent = data.total > 0 ? Math.round((data.processed / data.total) * 100) : 0;
            processingText.innerText = `处理中...(${data.processed}/${data.total})`;
            processingBar.style.width = `${progressPercent}%`;
        }
    }
    
    // 显示错误信息
    function showError(runId, data) {
        const resultsContainer = document.getElementById('results-container');
        
        // 移除处理中卡片（如果存在）
        const processingCard = document.getElementById(`processing-card-${runId}`);
        if (processingCard) {
            processingCard.remove();
        }
        
        // 创建错误卡片
        const card = document.createElement('div');
        card.id = `error-card-${runId}`;
        card.className = 'card mt-3';
        card.innerHTML = `
            <div class="card-header bg-danger text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">处理失败: ${data.evaluation_set_name || '评测集'} (ID: ${runId})</h5>
                <div>
                    <button class="btn btn-sm btn-light me-2" type="button" data-bs-toggle="collapse" data-bs-target="#error-body-${runId}" aria-expanded="true" aria-controls="error-body-${runId}">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                    <button type="button" class="btn-close btn-close-white" aria-label="Close"></button>
                </div>
            </div>
            <div class="collapse show" id="error-body-${runId}">
                <div class="card-body">
                    <div class="alert alert-danger mb-0">
                        <strong>错误信息:</strong> ${data.error || '未知错误'}
                    </div>
                </div>
            </div>
        `;
        resultsContainer.appendChild(card);
        
        // 添加关闭按钮事件
        card.querySelector('.btn-close').addEventListener('click', function() {
            card.remove();
        });
    }
    
    // 显示测试结果
    function showResults(runId, data) {
        const resultsContainer = document.getElementById('results-container');
        
        // 移除处理中卡片（如果存在）
        const processingCard = document.getElementById(`processing-card-${runId}`);
        if (processingCard) {
            processingCard.remove();
        }
        
        // 检查结果卡片是否已存在
        let card = document.getElementById(`result-card-${runId}`);
        if (card) {
            return; // 如果已存在，不重复创建
        }
        
        // 格式化时间显示
        const startTime = data.start_time ? new Date(data.start_time).toLocaleString('zh-CN') : '未知';
        const endTime = data.end_time ? new Date(data.end_time).toLocaleString('zh-CN') : new Date().toLocaleString('zh-CN');
        
        // 创建结果卡片
        card = document.createElement('div');
        card.id = `result-card-${runId}`;
        card.className = 'card mt-3';
        card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    ${data.evaluation_set_name || '评测集'} 
                    <small class="text-muted">
                        (${data.corpus_count || 0}条语料, 
                        ${startTime} - ${endTime})
                    </small>
                </h5>
                <div>
                    <button class="btn btn-success btn-sm export-btn me-2" data-run-id="${runId}">
                        <i class="bi bi-download me-1"></i>导出为Excel
                    </button>
                    <button class="btn btn-sm btn-light me-2" type="button" data-bs-toggle="collapse" data-bs-target="#result-body-${runId}" aria-expanded="true" aria-controls="result-body-${runId}">
                        <i class="bi bi-chevron-up"></i>
                    </button>
                    <button type="button" class="btn-close" aria-label="Close"></button>
                </div>
            </div>
            <div class="collapse show" id="result-body-${runId}">
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover result-table" id="resultTable-${runId}">
                            <thead class="table-light">
                                <tr>
                                    <th>语料内容</th>
                                    <th>预期响应</th>
                                    <th>实际响应</th>
                                    <th>评分</th>
                                    <th>语料类型</th>
                                    <th>创建时间</th>
                                    <th>版本</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- 结果将通过JavaScript动态填充 -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        resultsContainer.appendChild(card);
        
        // 填充数据
        const tbody = card.querySelector('tbody');
        data.data.forEach(row => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td style="white-space: pre-wrap; word-wrap: break-word;">${row.content}</td>
                <td style="white-space: pre-wrap; word-wrap: break-word;">${row.expected_response || ''}</td>
                <td style="white-space: pre-wrap; word-wrap: break-word;">${row.actual_response}</td>
                <td>${row.score !== null ? row.score : '-'}</td>
                <td>${row.corpus_type || ''}</td>
                <td>${row.created_at || ''}</td>
                <td>${row.version || ''}</td>
            `;
            tbody.appendChild(tr);
        });
        
        // 添加导出事件
        card.querySelector('.export-btn').addEventListener('click', function() {
            exportToExcel(runId);
        });
        
        // 添加关闭按钮事件
        card.querySelector('.btn-close').addEventListener('click', function() {
            card.remove();
        });
        
        // 添加折叠按钮事件
        const collapseBtn = card.querySelector('[data-bs-toggle="collapse"]');
        collapseBtn.addEventListener('click', function() {
            const icon = this.querySelector('i');
            if (icon.classList.contains('bi-chevron-down')) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-up');
            } else {
                icon.classList.remove('bi-chevron-up');
                icon.classList.add('bi-chevron-down');
            }
        });
    }
    
    // 导出为Excel
    function exportToExcel(runId) {
        // 创建工作簿
        var wb = XLSX.utils.book_new();
        
        // 获取表格数据
        var table = document.getElementById(`resultTable-${runId}`);
        var ws = XLSX.utils.table_to_sheet(table, {sheet:"Sheet1"});
        
        // 添加工作表到工作簿
        XLSX.utils.book_append_sheet(wb, ws, `评测结果_${runId}`);
        
        // 导出文件
        XLSX.writeFile(wb, `评测结果_${runId}.xlsx`);
    }
    
    // 取消运行按钮
    document.getElementById('cancel-run').addEventListener('click', function() {
        const savedRunInfo = localStorage.getItem('evaluationRunInfo');
        if (savedRunInfo) {
            const runInfo = JSON.parse(savedRunInfo);
            
            if (confirm('确定要取消当前运行吗？')) {
                // 获取CSRF token
                const csrfTokenElement = document.querySelector('[name=csrfmiddlewaretoken]');
                if (!csrfTokenElement) {
                    console.error('CSRF token not found');
                    alert('取消失败：CSRF token缺失');
                    return;
                }
                
                const csrfToken = csrfTokenElement.value;
                
                // 发送取消请求（这里可以扩展为取消所有运行）
                const runId = runInfo.runIds[0]; // 取第一个作为示例
                fetch('{% url "cancel_processing" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': csrfToken
                    },
                    body: `run_id=${runId}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        // 清除保存的运行信息
                        localStorage.removeItem('evaluationRunInfo');
                        
                        // 隐藏进度条
                        document.getElementById('progress-container').classList.add('d-none');
                        
                        alert('运行已取消');
                    } else {
                        alert('取消失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('取消请求失败');
                });
            }
        } else {
            // 如果没有保存的运行信息，只是重置表单
            localStorage.removeItem('evaluationRunInfo');
            document.getElementById('progress-container').classList.add('d-none');
        }
    });
</script>
{% endblock %}